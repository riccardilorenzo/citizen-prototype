<html>
    <head>
        <title>Citizen Prototype</title>
        <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
        <script src="bootstrap/js/bootstrap.min.js"></script>
        
        <script src="scripts/jquery.js"></script>

        <link rel="stylesheet" href="style/home.css">
        <script>
            function retrieveMessages() {
                $.get("/retrieveMessages", null, function(msgs) {
                    for (let i in msgs) {
                        // SPLIT msg TO GET AUTHOR AND MESSAGE; separator is "-" without quotes; sort messages by timestamp
                        $("#chat-list").val().append(author + ": " + message)
                    }
                })
                setTimeout(retrieveMessages, 5000)
            }

            function submitMessage(e) {
                e.preventDefault()
                let yourM = $("#chatmsg").val()
                $.post("/publishMessage", { message: yourM }, function(username) {
                    /*// Republish every message in the chat: TODO
                    $("#chat-table").append(msgs)*/
                    $("#chat-table").prepend("<tr><td>" + username + "</td><td>" + yourM + "</td>")
                }).fail(function(error) {
                    alert('Error: ' + (error.status == 400 ? "" : "generic"));
                    if (error.status == 400)
                        alert('Error: maximum length of 1024, minimum of 0')
                    else if (error.status == 500)
                        alert('Error: error while communicating with the blockchain')
                    /*else if (error.status == 403)
                        alert('Error: not authenticated')*/
                    else
                        alert('Error: generic')
                })
                return false;
            }
        </script>
    </head>
    <body onload="retrieveMessages()">
        <div class="container">
            <div id="header">
                <a href="/logout"><button class="btn btn-warning">Logout</button></a>
            </div>
            <!-- CHAT -->
            <div id="chat">
                <div id="chat-list">
                    <table id="chat-table">
                        
                    </table>
                </div>
                <div id="chat-msg">
                    <form id="chatForm" method="POST" onsubmit="submitMessage(event)">
                        <input type="text" placeholder="Inserisci il tuo messaggio" id="chatmsg" name="message" />
                        <input type="submit" value="Invia" class="btn btn-success" />
                        <input type="reset" value="Cancella" class="btn btn-danger" />
                    </form>
                </div>
            </div>
        </div>
    </body>
</html>